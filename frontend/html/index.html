<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real-time Traffic Violation Capture - E-Challan System</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      header h1 {
        font-size: 32px;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      header p {
        font-size: 16px;
        opacity: 0.9;
      }

      .main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .camera-section {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      .video-container {
        width: 100%;
        height: 500px;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      .video-stream {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .loading-spinner {
        position: absolute;
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .control-panel {
        padding: 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        background: #f8f9fa;
        border-bottom: 1px solid #ddd;
      }

      button {
        flex: 1;
        min-width: 120px;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-success {
        background: #48bb78;
        color: white;
      }

      .btn-success:hover {
        background: #38a169;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
      }

      .btn-danger {
        background: #f56565;
        color: white;
      }

      .btn-danger:hover {
        background: #e53e3e;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(245, 101, 101, 0.4);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .info-panel {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        max-height: 500px;
        overflow-y: auto;
      }

      .info-section {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }

      .info-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
      }

      .info-title {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        text-transform: uppercase;
        margin-bottom: 8px;
        letter-spacing: 0.5px;
      }

      .info-value {
        font-size: 16px;
        color: #667eea;
        font-weight: 500;
        word-break: break-all;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-running {
        background: #c6f6d5;
        color: #22543d;
      }

      .status-stopped {
        background: #fed7d7;
        color: #742a2a;
      }

      .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 14px;
      }

      .alert-success {
        background: #c6f6d5;
        color: #22543d;
        border-left: 4px solid #48bb78;
      }

      .alert-error {
        background: #fed7d7;
        color: #742a2a;
        border-left: 4px solid #f56565;
      }

      .alert-warning {
        background: #feebc8;
        color: #7c2d12;
        border-left: 4px solid #ed8936;
      }

      .bottom-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }

      .card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      .card h3 {
        margin-bottom: 15px;
        color: #333;
        font-size: 16px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: #666;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      input,
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .stat-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }

      .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
      }

      @media (max-width: 768px) {
        .main-grid {
          grid-template-columns: 1fr;
        }

        .bottom-section {
          grid-template-columns: 1fr;
        }

        header h1 {
          font-size: 24px;
        }

        .video-container {
          height: 350px;
        }
      }

      .echallan-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-top: 10px;
      }

      .echallan-number {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .penalty-amount {
        font-size: 16px;
        font-weight: 600;
        color: #ffd700;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üö® Real-time Traffic Violation Detector</h1>
        <p>Live Camera Feed with Automatic E-Challan Generation</p>
      </header>

      <div class="main-grid">
        <!-- Camera Section -->
        <div class="camera-section">
          <div class="control-panel">
            <button id="startBtn" class="btn-primary" onclick="startCamera()">
              Start Camera
            </button>
            <button
              id="captureBtn"
              class="btn-success"
              onclick="capturePhoto()"
              disabled
            >
              Capture & Analyze
            </button>
            <button
              id="detectBtn"
              class="btn-primary"
              onclick="detectViolation()"
              disabled
            >
              Detect Violation
            </button>
            <button
              id="stopBtn"
              class="btn-danger"
              onclick="stopCamera()"
              disabled
            >
              Stop Camera
            </button>
          </div>
          <div class="video-container">
            <img
              id="videoFeed"
              class="video-stream"
              src=""
              alt="Live Stream"
              style="display: none"
            />
            <div
              id="loadingSpinner"
              class="loading-spinner"
              style="display: none"
            ></div>
            <p id="noStreamText" style="color: #fff; font-size: 18px">
              Click "Start Camera" to begin
            </p>
          </div>
        </div>

        <!-- Info Panel -->
        <div class="info-panel">
          <div id="alerts"></div>

          <div class="info-section">
            <div class="info-title">Camera Status</div>
            <div>
              <span id="cameraStatus" class="status-badge status-stopped"
                >Stopped</span
              >
            </div>
          </div>

          <div class="info-section">
            <div class="info-title">Violations Detected</div>
            <div class="info-value" id="violationCount">0</div>
          </div>

          <div class="info-section">
            <div class="info-title">Vehicle Number</div>
            <div class="info-value" id="vehicleNumber">-</div>
          </div>

          <div class="info-section">
            <div class="info-title">E-Challan Status</div>
            <div class="info-value" id="echallanStatus">Not Generated</div>
          </div>

          <div class="info-section">
            <div class="info-title">Challan Number</div>
            <div
              class="info-value"
              id="echallanNumber"
              style="font-family: monospace"
            >
              -
            </div>
          </div>

          <div class="info-section">
            <div class="info-title">Penalty Amount</div>
            <div class="info-value" id="penaltyAmount">‚Çπ0</div>
          </div>

          <div class="info-section">
            <div class="info-title">Last Update</div>
            <div class="info-value" id="lastUpdate" style="font-size: 12px">
              -
            </div>
          </div>
        </div>
      </div>

      <!-- Bottom Section -->
      <div class="bottom-section">
        <!-- Location Configuration -->
        <div class="card">
          <h3>üìç Location Settings</h3>
          <div class="form-group">
            <label for="latitude">Latitude</label>
            <input type="number" id="latitude" value="28.7041" step="0.0001" />
          </div>
          <div class="form-group">
            <label for="longitude">Longitude</label>
            <input type="number" id="longitude" value="77.1025" step="0.0001" />
          </div>
          <div class="form-group">
            <label for="locationName">Location Name</label>
            <input type="text" id="locationName" value="Delhi" />
          </div>
          <button
            class="btn-primary"
            onclick="updateLocation()"
            style="width: 100%"
          >
            Update Location
          </button>
        </div>

        <!-- Statistics -->
        <div class="card">
          <h3>üìä Statistics</h3>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="totalCaptures">0</div>
              <div class="stat-label">Captures</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalViolations">0</div>
              <div class="stat-label">Violations</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalChallans">0</div>
              <div class="stat-label">Challans Issued</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalRevenue">‚Çπ0</div>
              <div class="stat-label">Revenue</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "http://127.0.0.1:8001/api";
      let cameraRunning = false;
      let streamInterval = null;
      let stats = {
        captures: 0,
        violations: 0,
        challans: 0,
        revenue: 0,
      };

      // Show alert
      function showAlert(message, type = "success") {
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;

        const alertsContainer = document.getElementById("alerts");
        alertsContainer.innerHTML = "";
        alertsContainer.appendChild(alertDiv);

        setTimeout(() => alertDiv.remove(), 5000);
      }

      // Start camera
      async function startCamera() {
        try {
          document.getElementById("loadingSpinner").style.display = "block";
          document.getElementById("noStreamText").style.display = "none";

          const response = await fetch(`${API_BASE}/camera/start`, {
            method: "POST",
          });
          const data = await response.json();

          if (data.status === "success") {
            cameraRunning = true;
            updateUI();
            startStreamRefresh();
            showAlert("Camera started successfully!", "success");
          } else {
            showAlert("Failed to start camera", "error");
          }
        } catch (error) {
          showAlert(`Error: ${error.message}`, "error");
          document.getElementById("loadingSpinner").style.display = "none";
        }
      }

      // Stop camera
      async function stopCamera() {
        try {
          const response = await fetch(`${API_BASE}/camera/stop`, {
            method: "POST",
          });
          const data = await response.json();

          if (data.status === "success") {
            cameraRunning = false;
            stopStreamRefresh();
            document.getElementById("videoFeed").style.display = "none";
            document.getElementById("noStreamText").style.display = "block";
            updateUI();
            showAlert("Camera stopped", "warning");
          }
        } catch (error) {
          showAlert(`Error: ${error.message}`, "error");
        }
      }

      // Start refreshing stream
      function startStreamRefresh() {
        streamInterval = setInterval(async () => {
          try {
            const response = await fetch(`${API_BASE}/camera/current-frame`);
            if (response.ok) {
              const data = await response.json();
              document.getElementById(
                "videoFeed"
              ).src = `data:image/jpeg;base64,${data.image}`;
              document.getElementById("videoFeed").style.display = "block";
              document.getElementById("loadingSpinner").style.display = "none";
            }
          } catch (error) {
            console.error("Stream error:", error);
          }
        }, 100); // Refresh every 100ms for ~10 FPS
      }

      // Stop refreshing stream
      function stopStreamRefresh() {
        if (streamInterval) {
          clearInterval(streamInterval);
          streamInterval = null;
        }
      }

      // Capture photo
      async function capturePhoto() {
        try {
          const latitude = parseFloat(
            document.getElementById("latitude").value
          );
          const longitude = parseFloat(
            document.getElementById("longitude").value
          );
          const locationName = document.getElementById("locationName").value;

          const formData = new FormData();
          formData.append("latitude", latitude);
          formData.append("longitude", longitude);
          formData.append("location_name", locationName);

          const response = await fetch(`${API_BASE}/camera/capture`, {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          if (data.status === "success") {
            updateResults(data);
            stats.captures++;
            if (data.violations_detected > 0) {
              stats.violations += data.violations_detected;
            }
            if (data.echallan_generated) {
              stats.challans++;
              stats.revenue += data.penalty_amount;
            }
            updateStats();
            showAlert(
              `Photo captured! Violations: ${data.violations_detected}`,
              data.violations_detected > 0 ? "warning" : "success"
            );
          } else {
            showAlert("Failed to capture photo", "error");
          }
        } catch (error) {
          showAlert(`Error: ${error.message}`, "error");
        }
      }

      // Detect violation
      async function detectViolation() {
        try {
          const latitude = parseFloat(
            document.getElementById("latitude").value
          );
          const longitude = parseFloat(
            document.getElementById("longitude").value
          );
          const locationName = document.getElementById("locationName").value;

          const formData = new FormData();
          formData.append("latitude", latitude);
          formData.append("longitude", longitude);
          formData.append("location_name", locationName);

          const response = await fetch(`${API_BASE}/camera/detect-violation`, {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          if (data.status === "success") {
            updateResults(data);
            showAlert(
              `Detection complete! Violations: ${data.violations_detected}`,
              "success"
            );
          } else {
            showAlert("Detection failed", "error");
          }
        } catch (error) {
          showAlert(`Error: ${error.message}`, "error");
        }
      }

      // Update results
      function updateResults(data) {
        document.getElementById("violationCount").textContent =
          data.violations_detected || 0;
        document.getElementById("vehicleNumber").textContent =
          data.vehicle_number || "-";
        document.getElementById("echallanStatus").textContent =
          data.echallan_generated ? "Generated" : "Not Generated";
        document.getElementById("echallanNumber").textContent =
          data.echallan_number || "-";
        document.getElementById("penaltyAmount").textContent =
          "‚Çπ" + (data.penalty_amount || 0);
        document.getElementById("lastUpdate").textContent =
          new Date().toLocaleTimeString();
      }

      // Update UI
      function updateUI() {
        const statusEl = document.getElementById("cameraStatus");
        const startBtn = document.getElementById("startBtn");
        const captureBtn = document.getElementById("captureBtn");
        const detectBtn = document.getElementById("detectBtn");
        const stopBtn = document.getElementById("stopBtn");

        if (cameraRunning) {
          statusEl.textContent = "Running";
          statusEl.className = "status-badge status-running";
          startBtn.disabled = true;
          captureBtn.disabled = false;
          detectBtn.disabled = false;
          stopBtn.disabled = false;
        } else {
          statusEl.textContent = "Stopped";
          statusEl.className = "status-badge status-stopped";
          startBtn.disabled = false;
          captureBtn.disabled = true;
          detectBtn.disabled = true;
          stopBtn.disabled = true;
        }
      }

      // Update location
      function updateLocation() {
        const lat = document.getElementById("latitude").value;
        const lon = document.getElementById("longitude").value;
        const name = document.getElementById("locationName").value;
        showAlert(`Location updated: ${lat}, ${lon} (${name})`, "success");
      }

      // Update stats
      function updateStats() {
        document.getElementById("totalCaptures").textContent = stats.captures;
        document.getElementById("totalViolations").textContent =
          stats.violations;
        document.getElementById("totalChallans").textContent = stats.challans;
        document.getElementById("totalRevenue").textContent =
          "‚Çπ" + stats.revenue;
      }

      // Initial UI update
      updateUI();
    </script>
  </body>
</html>
